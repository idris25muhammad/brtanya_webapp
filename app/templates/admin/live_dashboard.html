<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Dashboard - {{ session.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100">
    <header class="bg-gray-800 shadow-lg border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="{{ url_for('static', filename='images/brtanya_logo.png') }}" alt="BRTanya Logo" class="h-10 w-auto">
                    <div>
                        <h1 class="text-xl font-bold text-cyan-400">Live Dashboard</h1>
                        <p class="text-sm text-gray-400">{{ session.title }}</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <a href="/admin" class="px-4 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition">‚Üê Back</a>
                    <button id="sessionControlBtn" onclick="toggleSession()" class="px-4 py-2 bg-lime-500 text-gray-900 rounded-lg hover:bg-lime-400 transition font-semibold">
                        <span id="sessionControlText">Start Session</span>
                    </button>
                    <button onclick="endSession()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">End Session</button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Warning Message -->
        <div id="notStartedMessage" class="mb-6 bg-yellow-900/30 border-l-4 border-yellow-500 rounded-lg p-4">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div class="flex-1">
                    <p class="font-bold text-yellow-300">Session Belum Dimulai</p>
                    <p class="text-sm text-yellow-200 mt-1">Klik "Start Session" untuk memulai. Participants bisa scan QR atau input code.</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 border-l-4 border-cyan-500">
                <div class="flex items-center justify-between mb-2">
                    <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span class="px-2 py-1 bg-cyan-500/20 text-cyan-300 text-xs font-bold rounded-full" id="pollStatus">‚óè Not Started</span>
                </div>
                <p class="text-sm text-gray-400">Participants</p>
                <p class="text-3xl font-bold text-cyan-400 mt-1" id="totalParticipants">0</p>
                <p class="text-xs text-gray-500 mt-2">Online now</p>
            </div>

            <div class="bg-gray-800 rounded-lg shadow-lg p-6 border-l-4 border-lime-500">
                <div class="flex items-center justify-between mb-2">
                    <svg class="w-8 h-8 text-lime-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs text-gray-500 font-mono" id="slideNumber">Slide -</span>
                </div>
                <p class="text-sm text-gray-400">Current Votes</p>
                <p class="text-3xl font-bold text-lime-400 mt-1" id="currentSlideVotes">0</p>
                <p class="text-xs text-gray-500 mt-2">This slide</p>
            </div>

            <div class="bg-gray-800 rounded-lg shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between mb-2">
                    <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="text-xs text-gray-500">All slides</span>
                </div>
                <p class="text-sm text-gray-400">Total Votes</p>
                <p class="text-3xl font-bold text-purple-400 mt-1" id="totalAllVotes">0</p>
                <p class="text-xs text-gray-500 mt-2">All responses</p>
            </div>
        </div>

        <!-- ROW 1: Join Session (30%) + All Slides (70%) -->
        <div class="grid grid-cols-10 gap-6 mb-6">
            <!-- Join Session Card (30%) -->
            <div class="col-span-3">
                <div class="bg-gradient-to-br from-purple-600 via-purple-700 to-purple-900 rounded-xl shadow-2xl p-6">
                    <div class="text-center mb-4">
                        <h3 class="text-xl font-bold text-white mb-2">üì± Join Session</h3>
                        <p class="text-purple-200 text-sm">Scan QR or enter code</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur rounded-lg p-4 mb-4 border border-purple-400/20">
                        <p class="text-sm text-purple-100 mb-2 text-center font-medium">Session Code:</p>
                        <div class="bg-white rounded-lg py-3 px-4 mb-3">
                            <p class="text-3xl font-bold text-purple-600 tracking-wider text-center" id="displaySessionCode">{{ session.code }}</p>
                        </div>
                        <p class="text-xs text-purple-100 text-center break-all font-mono" id="joinURL"></p>
                    </div>
                    <div class="space-y-3">
                        <button onclick="showQRModal()" class="w-full py-3 bg-white text-purple-600 rounded-lg hover:bg-purple-50 transition font-bold shadow-md flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                            </svg>
                            Show QR Code
                        </button>
                        <button onclick="copyJoinURL()" class="w-full py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-400 transition font-bold shadow-md flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy URL
                        </button>
                    </div>
                </div>
            </div>

            <!-- All Slides (70%) -->
            <div class="col-span-7">
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                    <h2 class="text-lg font-bold text-lime-400 mb-4">üìù All Slides</h2>
                    <div class="grid grid-cols-2 gap-3 max-h-[380px] overflow-y-auto pr-2" id="slidesOverview">
                        <p class="col-span-2 text-sm text-gray-500 text-center py-4">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 2: Current Poll + Slide Navigation (Single Container) -->
        <div class="mb-6">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                <!-- Current Poll Header -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-cyan-400">üìä Current Poll</h2>
                    <span class="px-3 py-1 bg-purple-500/20 text-purple-300 text-xs font-bold rounded-full" id="pollTypeLabel">-</span>
                </div>
                
                <!-- Poll Question -->
                <p class="text-gray-100 font-medium text-lg leading-relaxed mb-6" id="pollQuestion">Waiting to start...</p>
                
                <!-- Slide Navigation (inside same container) -->
                <div id="slideNavigation" class="hidden border-t border-gray-700 pt-6">
                    <div class="flex items-center justify-between">
                        <button onclick="previousSlide()" id="prevBtn" class="flex items-center gap-2 px-6 py-3 bg-gray-700 border-2 border-gray-600 rounded-lg hover:bg-gray-600 transition disabled:opacity-30 disabled:cursor-not-allowed text-cyan-300 font-semibold" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Previous
                        </button>
                        <div class="flex items-center gap-6">
                            <div class="text-center">
                                <p class="text-sm text-gray-400 mb-1 font-medium">Current Slide</p>
                                <div class="flex items-center gap-3">
                                    <span class="text-4xl font-bold text-cyan-400" id="currentSlideNum">1</span>
                                    <span class="text-2xl text-gray-600">/</span>
                                    <span class="text-2xl font-semibold text-gray-400" id="totalSlides">0</span>
                                </div>
                            </div>
                            <div class="flex gap-2" id="progressDots"></div>
                        </div>
                        <button onclick="nextSlide()" id="nextBtn" class="flex items-center gap-2 px-6 py-3 bg-lime-500 text-gray-900 rounded-lg hover:bg-lime-400 transition disabled:opacity-30 disabled:cursor-not-allowed shadow-lg font-bold">
                            Next
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="mt-4 w-full bg-gray-700 rounded-full h-3">
                        <div id="progressBar" class="bg-gradient-to-r from-cyan-500 via-lime-500 to-purple-500 h-3 rounded-full transition-all duration-300 shadow-lg" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3: Live Chart (Full Width) -->
        <div class="mb-6">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold text-purple-400">üìà Live Results - Slide <span id="chartSlideNum" class="text-cyan-400">-</span></h2>
                    <div class="flex gap-2" id="chartTypeButtons">
                        <button onclick="changeChartType('bar')" class="px-3 py-2 text-sm font-semibold border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition">Bar</button>
                        <button onclick="changeChartType('pie')" class="px-3 py-2 text-sm font-semibold border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition">Pie</button>
                        <button onclick="changeChartType('doughnut')" class="px-3 py-2 text-sm font-semibold border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition">Doughnut</button>
                    </div>
                </div>
                <div class="relative" style="height: 400px;">
                    <canvas id="resultsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ROW 4: Detailed Breakdown + Activity Feed -->
        <div class="grid grid-cols-2 gap-6">
            <!-- Detailed Breakdown -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                <h2 class="text-lg font-bold text-lime-400 mb-4">üìä Detailed Breakdown</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-700">
                                <th class="text-left py-3 px-4 font-bold text-cyan-400">Option</th>
                                <th class="text-center py-3 px-4 font-bold text-cyan-400">Votes</th>
                                <th class="text-center py-3 px-4 font-bold text-cyan-400">%</th>
                                <th class="text-left py-3 px-4 font-bold text-cyan-400">Bar</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-12 text-gray-500">
                                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p>No data yet</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                <h2 class="text-lg font-bold text-purple-400 mb-4">üîî Activity Feed</h2>
                <div class="space-y-2 max-h-80 overflow-y-auto pr-2" id="activityFeed">
                    <div class="flex items-center gap-3 p-3 bg-gray-700/50 rounded-lg">
                        <div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-200">Dashboard loaded</p>
                            <p class="text-xs text-gray-500">Just now</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- QR Modal -->
    <div id="qrModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-600 via-purple-700 to-purple-900 rounded-2xl shadow-2xl max-w-lg w-full p-8 relative animate-fade-in">
            <button onclick="closeQRModal()" class="absolute top-4 right-4 text-white hover:text-gray-200 transition">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <div class="text-center">
                <h3 class="text-3xl font-bold text-white mb-2">üì± Scan to Join</h3>
                <p class="text-purple-200 mb-6">Point your camera at the QR code</p>
                <div class="inline-block p-6 bg-white rounded-2xl shadow-2xl mb-6">
                    <div id="qrcodeContainer" class="flex items-center justify-center" style="width: 300px; height: 300px;"></div>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-lg p-4 border border-purple-400/20 mb-4">
                    <p class="text-sm text-purple-100 mb-2 font-medium">Session Code:</p>
                    <p class="text-4xl font-bold text-white tracking-wider mb-3" id="modalSessionCode">{{ session.code }}</p>
                    <p class="text-xs text-purple-100 break-all font-mono" id="modalJoinURL"></p>
                </div>
                <button onclick="copyJoinURL()" class="w-full py-3 bg-white text-purple-600 rounded-lg hover:bg-purple-50 transition font-bold shadow-md">üìã Copy Join URL</button>
            </div>
        </div>
    </div>

    <script>
        const sessionCode = '{{ session.code }}';
        const sessionId = {{ session.id }};
        let socket, polls = [], currentSlideIndex = 0, totalSlidesCount = 0, sessionStarted = false, participantCount = 0, resultsChart, currentChartType = 'bar', qrCodeGenerated = false;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadSessionData();
            initializeSocket();
            setupJoinURL();
            setupKeyboardShortcuts();
        });

        function setupJoinURL() {
            const joinURL = `${window.location.origin}/join?code=${sessionCode}`;
            document.getElementById('joinURL').textContent = joinURL;
            document.getElementById('modalJoinURL').textContent = joinURL;
            document.getElementById('modalSessionCode').textContent = sessionCode;
        }

        async function loadSessionData() {
            try {
                const response = await fetch(`/admin/api/sessions/${sessionCode}`);
                const data = await response.json();
                polls = data.polls;
                totalSlidesCount = polls.length;
                participantCount = data.participant_count;
                sessionStarted = data.is_active || false;
                document.getElementById('totalSlides').textContent = totalSlidesCount;
                document.getElementById('totalParticipants').textContent = participantCount;
                updateSessionUI();
                renderSlidesOverview();
                updateTotalVotes();
                addActivity('Session loaded');
            } catch (error) {
                console.error('Error:', error);
                addActivity('Failed to load session', 'error');
            }
        }

        function updateSessionUI() {
            if (sessionStarted) {
                document.getElementById('sessionControlBtn').classList.remove('bg-lime-500', 'hover:bg-lime-400');
                document.getElementById('sessionControlBtn').classList.add('bg-yellow-500', 'hover:bg-yellow-400');
                document.getElementById('sessionControlText').textContent = 'Pause Session';
                document.getElementById('notStartedMessage').classList.add('hidden');
                document.getElementById('slideNavigation').classList.remove('hidden');
                document.getElementById('pollStatus').innerHTML = '‚óè Active';
                document.getElementById('pollStatus').className = 'px-2 py-1 bg-lime-500/20 text-lime-300 text-xs font-bold rounded-full';
            } else {
                document.getElementById('sessionControlBtn').classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
                document.getElementById('sessionControlBtn').classList.add('bg-lime-500', 'hover:bg-lime-400');
                document.getElementById('sessionControlText').textContent = 'Start Session';
                document.getElementById('notStartedMessage').classList.remove('hidden');
                document.getElementById('slideNavigation').classList.add('hidden');
                document.getElementById('pollStatus').innerHTML = '‚óè Not Started';
                document.getElementById('pollStatus').className = 'px-2 py-1 bg-cyan-500/20 text-cyan-300 text-xs font-bold rounded-full';
            }
            
            // ALWAYS load first slide data for preview (even when inactive)
            if (polls.length > 0) {
                updateSlideDisplay(polls[0]);
                loadSlideResults(polls[0].id);
            }
        }


        function initializeSocket() {
            socket = io();
            socket.on('connect', () => {
                socket.emit('admin_join', { session_code: sessionCode });
                addActivity('Connected to server');
            });
            socket.on('participant_joined', (data) => {
                participantCount = data.count;
                document.getElementById('totalParticipants').textContent = participantCount;
                addActivity(`Participant joined (${participantCount})`);
            });
            socket.on('participant_left', (data) => {
                participantCount = data.count;
                document.getElementById('totalParticipants').textContent = participantCount;
            });
            socket.on('new_vote', (data) => {
                updateVoteResults(data);
                addActivity(`New vote: ${data.answer}`);
            });
            socket.on('session_status_changed', (data) => {
                if (data.is_active) {
                    addActivity('Session resumed by admin', 'success');
                } else {
                    addActivity('Session paused by admin', 'warning');
                }
            });
        }

        async function toggleSession() {
            sessionStarted ? await pauseSession() : await startSession();
        }

        async function startSession() {
            try {
                await fetch(`/admin/api/sessions/${sessionCode}/toggle`, { method: 'PUT' });
                sessionStarted = true;
                updateSessionUI();
                if (polls.length > 0) loadSlide(0);
                addActivity('Session started', 'success');
                showNotification('‚úÖ Started!', 'success');
            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Failed to start', 'error');
            }
        }

        async function pauseSession() {
            try {
                await fetch(`/admin/api/sessions/${sessionCode}/toggle`, { method: 'PUT' });
                sessionStarted = false;
                updateSessionUI();
                addActivity('Session paused', 'warning');
                showNotification('‚è∏Ô∏è Paused', 'info');
            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Failed to pause', 'error');
            }
        }

        async function endSession() {
            if (!confirm('‚ö†Ô∏è End session? All data will be saved.')) return;
            try {
                const response = await fetch(`/admin/api/sessions/${sessionCode}/end`, { method: 'PUT' });
                if (response.ok) {
                    socket.emit('session_ended', { session_code: sessionCode });
                    showNotification('‚úÖ Session ended', 'success');
                    addActivity('Session ended', 'error');
                    setTimeout(() => window.location.href = '/admin', 2000);
                } else {
                    showNotification('‚ùå Failed to end session', 'error');
                }
            } catch (error) {
                console.error('Error ending session:', error);
                showNotification('‚ùå Failed to end session', 'error');
            }
        }

        async function loadSlide(slideIndex) {
            // Remove check: allow navigation even when inactive
            currentSlideIndex = slideIndex;
            const poll = polls[slideIndex];
            
            // Only emit socket event if session is active
            if (sessionStarted) {
                try {
                    await fetch(`/admin/api/sessions/${sessionCode}/slide`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slide_index: slideIndex })
                    });
                } catch (error) {
                    console.error('Failed to update slide on server:', error);
                }
            }
            
            updateSlideDisplay(poll);
            await loadSlideResults(poll.id);
        }


        function updateSlideDisplay(poll) {
            document.getElementById('currentSlideNum').textContent = currentSlideIndex + 1;
            document.getElementById('slideNumber').textContent = `Slide ${currentSlideIndex + 1}`;
            document.getElementById('chartSlideNum').textContent = currentSlideIndex + 1;
            document.getElementById('pollQuestion').textContent = poll.question;
            document.getElementById('pollTypeLabel').textContent = poll.poll_type === 'word_cloud' ? '‚òÅÔ∏è WORD CLOUD' : 'üìä MULTIPLE CHOICE';
            const progress = ((currentSlideIndex + 1) / totalSlidesCount) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            updateProgressDots();
            document.getElementById('prevBtn').disabled = currentSlideIndex === 0;
            document.getElementById('nextBtn').disabled = currentSlideIndex === totalSlidesCount - 1;
            renderSlidesOverview();
            addActivity(`Slide ${currentSlideIndex + 1}: ${poll.question}`);
        }

        function updateProgressDots() {
            const dotsContainer = document.getElementById('progressDots');
            dotsContainer.innerHTML = '';
            for (let i = 0; i < totalSlidesCount; i++) {
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full ${i === currentSlideIndex ? 'bg-cyan-400' : 'bg-gray-600'} transition-colors duration-300`;
                dotsContainer.appendChild(dot);
            }
        }

        function previousSlide() {
            if (currentSlideIndex > 0) loadSlide(currentSlideIndex - 1);
        }

        function nextSlide() {
            if (currentSlideIndex < totalSlidesCount - 1) loadSlide(currentSlideIndex + 1);
        }

        function jumpToSlide(index) {
            loadSlide(index);
        }

        async function loadSlideResults(pollId) {
            const poll = polls[currentSlideIndex];
            const results = poll.results || {};
            const totalVotes = Object.values(results).reduce((a, b) => a + b, 0);
            document.getElementById('currentSlideVotes').textContent = totalVotes;
            
            // Hide/show chart type buttons based on poll type
            const chartTypeButtons = document.getElementById('chartTypeButtons');
            if (poll.poll_type === 'word_cloud') {
                chartTypeButtons.classList.add('hidden');
            } else {
                chartTypeButtons.classList.remove('hidden');
            }
            
            updateChart(poll.options, results);
            updateResultsTable(poll.options, results);
        }

        function updateChart(options, results) {
            const canvas = document.getElementById('resultsChart');
            const currentPoll = polls[currentSlideIndex];
            
            // Word Cloud rendering using WordCloud library
            if (currentPoll.poll_type === 'word_cloud') {
                if (resultsChart) {
                    resultsChart.destroy();
                    resultsChart = null;
                }
                renderWordCloud(results);
                return;
            }
            
            // Multiple Choice - normal chart
            const ctx = canvas.getContext('2d');
            const votes = options.map(opt => results[opt] || 0);
            if (resultsChart) resultsChart.destroy();
            
            resultsChart = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: options,
                    datasets: [{
                        label: 'Votes',
                        data: votes,
                        backgroundColor: ['rgba(34,211,238,0.8)', 'rgba(163,230,53,0.8)', 'rgba(168,85,247,0.8)', 'rgba(251,191,36,0.8)', 'rgba(244,63,94,0.8)'],
                        borderColor: ['rgba(34,211,238,1)', 'rgba(163,230,53,1)', 'rgba(168,85,247,1)', 'rgba(251,191,36,1)', 'rgba(244,63,94,1)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: currentChartType !== 'bar',
                            position: 'bottom',
                            labels: { color: '#9ca3af', font: { size: 12, weight: 'bold' } }
                        }
                    },
                    scales: currentChartType === 'bar' ? {
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: '#9ca3af' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    } : {}
                }
            });
        }

        function renderWordCloud(results) {
            const canvas = document.getElementById('resultsChart');
            
            // Clear canvas and set proper dimensions
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            const words = Object.entries(results).map(([word, count]) => [word, count * 10]);
            
            if (words.length === 0) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '24px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('‚òÅÔ∏è No responses yet', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Use WordCloud library
            WordCloud(canvas, {
                list: words,
                gridSize: 8,
                weightFactor: 2,
                fontFamily: 'Arial, sans-serif',
                color: function() {
                    const colors = ['#22d3ee', '#a3e635', '#a855f7', '#fbbf24', '#f43f5e'];
                    return colors[Math.floor(Math.random() * colors.length)];
                },
                backgroundColor: 'transparent',
                rotateRatio: 0.3,
                rotationSteps: 2,
                minSize: 16,
                drawOutOfBound: false,
                shrinkToFit: true
            });
        }

        function changeChartType(type) {
            const currentPoll = polls[currentSlideIndex];
            if (currentPoll && currentPoll.poll_type === 'word_cloud') {
                showNotification('üí° Word Cloud has fixed visualization', 'info');
                return;
            }
            
            currentChartType = type;
            if (sessionStarted && polls[currentSlideIndex]) {
                updateChart(polls[currentSlideIndex].options, polls[currentSlideIndex].results || {});
            }
        }

        function updateResultsTable(options, results) {
            const tbody = document.getElementById('resultsTableBody');
            const currentPoll = polls[currentSlideIndex];
            
            // Word Cloud table format
            if (currentPoll.poll_type === 'word_cloud') {
                const words = Object.entries(results).map(([word, count]) => ({ word, count }));
                words.sort((a, b) => b.count - a.count);
                
                const totalVotes = words.reduce((sum, item) => sum + item.count, 0);
                const colors = [
                    {bg: 'bg-cyan-500/20', text: 'text-cyan-300', bar: 'bg-cyan-500'},
                    {bg: 'bg-lime-500/20', text: 'text-lime-300', bar: 'bg-lime-500'},
                    {bg: 'bg-purple-500/20', text: 'text-purple-300', bar: 'bg-purple-500'},
                    {bg: 'bg-amber-500/20', text: 'text-amber-300', bar: 'bg-amber-500'},
                    {bg: 'bg-rose-500/20', text: 'text-rose-300', bar: 'bg-rose-500'}
                ];
                
                tbody.innerHTML = words.slice(0, 20).map((item, i) => {
                    const percentage = totalVotes > 0 ? ((item.count / totalVotes) * 100).toFixed(1) : 0;
                    const color = colors[i % colors.length];
                    return `<tr class="border-b border-gray-700 hover:bg-gray-700/30"><td class="py-3 px-4 font-semibold text-gray-200">${item.word}</td><td class="py-3 px-4 text-center text-gray-200 font-bold">${item.count}</td><td class="py-3 px-4 text-center"><span class="inline-block px-3 py-1 ${color.bg} ${color.text} font-bold rounded-full">${percentage}%</span></td><td class="py-3 px-4"><div class="w-full bg-gray-700 rounded-full h-3"><div class="${color.bar} h-3 rounded-full transition-all duration-300" style="width: ${percentage}%"></div></div></td></tr>`;
                }).join('');
                
                if (words.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-gray-500"><svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg><p>No responses yet</p></td></tr>`;
                }
                return;
            }
            
            // Multiple Choice table format
            const totalVotes = Object.values(results).reduce((a, b) => a + b, 0);
            const colors = [
                {bg: 'bg-cyan-500/20', text: 'text-cyan-300', bar: 'bg-cyan-500'},
                {bg: 'bg-lime-500/20', text: 'text-lime-300', bar: 'bg-lime-500'},
                {bg: 'bg-purple-500/20', text: 'text-purple-300', bar: 'bg-purple-500'},
                {bg: 'bg-amber-500/20', text: 'text-amber-300', bar: 'bg-amber-500'},
                {bg: 'bg-rose-500/20', text: 'text-rose-300', bar: 'bg-rose-500'}
            ];
            tbody.innerHTML = options.map((option, i) => {
                const votes = results[option] || 0;
                const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                const color = colors[i % colors.length];
                return `<tr class="border-b border-gray-700 hover:bg-gray-700/30"><td class="py-3 px-4 font-semibold text-gray-200">${option}</td><td class="py-3 px-4 text-center text-gray-200 font-bold">${votes}</td><td class="py-3 px-4 text-center"><span class="inline-block px-3 py-1 ${color.bg} ${color.text} font-bold rounded-full">${percentage}%</span></td><td class="py-3 px-4"><div class="w-full bg-gray-700 rounded-full h-3"><div class="${color.bar} h-3 rounded-full transition-all duration-300" style="width: ${percentage}%"></div></div></td></tr>`;
            }).join('');
        }

        function renderSlidesOverview() {
            const container = document.getElementById('slidesOverview');
            if (polls.length === 0) return container.innerHTML = '<p class="col-span-2 text-sm text-gray-500 text-center py-4">No slides</p>';
            container.innerHTML = polls.map((poll, index) => {
                const isActive = index === currentSlideIndex;
                const results = poll.results || {};
                const totalVotes = Object.values(results).reduce((a, b) => a + b, 0);
                const pollIcon = poll.poll_type === 'word_cloud' ? '‚òÅÔ∏è' : 'üìä';
                return `<div onclick="jumpToSlide(${index})" class="cursor-pointer p-3 rounded-lg border-2 ${isActive ? 'border-cyan-500 bg-cyan-500/10' : 'border-gray-700 hover:border-purple-500 hover:bg-gray-700/50'} transition"><div class="flex items-center gap-2 mb-1"><span class="text-xs font-bold ${isActive ? 'text-cyan-400' : 'text-gray-500'}">${pollIcon} Slide ${index + 1}</span>${isActive && sessionStarted ? '<span class="px-2 py-0.5 bg-lime-500 text-gray-900 text-xs rounded-full font-bold">Active</span>' : ''}</div><p class="text-sm font-medium text-gray-200 line-clamp-2">${poll.question}</p><p class="text-xs text-gray-500 mt-1">${totalVotes} responses</p></div>`;
            }).join('');
        }

        function updateVoteResults(data) {
            const poll = polls.find(p => p.id === data.poll_id);
            if (poll) {
                poll.results = data.results;
                if (poll.id === polls[currentSlideIndex].id) loadSlideResults(poll.id);
                updateTotalVotes();
            }
        }

        function updateTotalVotes() {
            const total = polls.reduce((sum, poll) => {
                const results = poll.results || {};
                return sum + Object.values(results).reduce((a, b) => a + b, 0);
            }, 0);
            document.getElementById('totalAllVotes').textContent = total;
        }

        function showQRModal() {
            document.getElementById('qrModal').classList.remove('hidden');
            if (!qrCodeGenerated) {
                generateQRCode();
                qrCodeGenerated = true;
            }
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.add('hidden');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeQRModal();
        });

        document.getElementById('qrModal').addEventListener('click', (e) => {
            if (e.target.id === 'qrModal') closeQRModal();
        });

        function generateQRCode() {
            const joinURL = `${window.location.origin}/join?code=${sessionCode}`;
            const qrContainer = document.getElementById('qrcodeContainer');
            qrContainer.innerHTML = '';
            try {
                new QRCode(qrContainer, {
                    text: joinURL,
                    width: 300,
                    height: 300,
                    colorDark: "#7c3aed",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (error) {
                qrContainer.innerHTML = '<div class="flex items-center justify-center w-full h-full"><p class="text-red-500">QR failed</p></div>';
            }
        }

        function copyJoinURL() {
            const joinURL = `${window.location.origin}/join?code=${sessionCode}`;
            navigator.clipboard.writeText(joinURL).then(() => showNotification('‚úÖ URL copied!', 'success'));
        }

        function addActivity(message, type = 'info') {
            const colors = { info: 'bg-cyan-500', success: 'bg-lime-500', warning: 'bg-amber-500', error: 'bg-red-500' };
            const activityItem = document.createElement('div');
            activityItem.className = 'flex items-center gap-3 p-3 bg-gray-700/50 rounded-lg';
            activityItem.innerHTML = `<div class="w-2 h-2 ${colors[type]} rounded-full animate-pulse"></div><div class="flex-1"><p class="text-sm text-gray-200">${message}</p><p class="text-xs text-gray-500">Just now</p></div>`;
            const feed = document.getElementById('activityFeed');
            feed.insertBefore(activityItem, feed.firstChild);
            if (feed.children.length > 15) feed.removeChild(feed.lastChild);
        }

        function showNotification(message, type = 'info') {
            const colors = { success: 'bg-lime-500', error: 'bg-red-600', info: 'bg-cyan-500', warning: 'bg-amber-500' };
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-2xl text-gray-900 z-50 ${colors[type]} font-bold`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (!sessionStarted) return;
                if (e.key === 'ArrowLeft') { e.preventDefault(); previousSlide(); }
                if (e.key === 'ArrowRight') { e.preventDefault(); nextSlide(); }
            });
        }
    </script>
</body>
</html>
